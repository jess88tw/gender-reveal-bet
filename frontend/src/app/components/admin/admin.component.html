<div class="admin-container">
  <header class="page-header">
    <a routerLink="/" class="back-btn">â† è¿”å›</a>
    <h1>âš™ï¸ ç®¡ç†å“¡å¾Œå°</h1>
  </header>

  @if (!isLoggedIn()) {
    <div class="login-prompt">
      <p>è«‹å…ˆç™»å…¥ç®¡ç†å“¡å¸³è™Ÿ</p>
      <a routerLink="/" class="btn btn-primary">è¿”å›é¦–é ç™»å…¥</a>
    </div>
  } @else if (loading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>è¼‰å…¥ä¸­...</p>
    </div>
  } @else if (error()) {
    <div class="error-banner">
      <p>âš ï¸ {{ error() }}</p>
      <button (click)="loadData()" class="btn btn-small">é‡è©¦</button>
    </div>
  } @else {
    <!-- Success/Error Messages -->
    @if (successMessage()) {
      <div class="success-banner">
        <p>âœ… {{ successMessage() }}</p>
        <button (click)="clearMessages()" class="close-btn">âœ•</button>
      </div>
    }

    <!-- Stats Overview -->
    <section class="stats-overview">
      <h2>ğŸ“Š ä¸‹æ³¨çµ±è¨ˆ</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-number">{{ totalBets() }}</span>
          <span class="stat-label">ç¸½ä¸‹æ³¨æ•¸</span>
        </div>
        <div class="stat-card paid">
          <span class="stat-number">{{ paidBets().length }}</span>
          <span class="stat-label">å·²ä»˜æ¬¾</span>
        </div>
        <div class="stat-card unpaid">
          <span class="stat-number">{{ unpaidBets().length }}</span>
          <span class="stat-label">å¾…ä»˜æ¬¾</span>
        </div>
        <div class="stat-card pool">
          <span class="stat-number">NT$ {{ totalPool() | number }}</span>
          <span class="stat-label">çé‡‘æ± </span>
        </div>
      </div>
      <div class="gender-stats">
        <div class="gender-stat boy">
          <span>ğŸ‘¦ ç”·ç”Ÿï¼š{{ boyBets().length }} æ³¨</span>
        </div>
        <div class="gender-stat girl">
          <span>ğŸ‘§ å¥³ç”Ÿï¼š{{ girlBets().length }} æ³¨</span>
        </div>
      </div>
    </section>

    <!-- Bet Management -->
    <section class="bet-management">
      <h2>ğŸ’³ ä¸‹æ³¨ç®¡ç†</h2>
      @if (allBets().length === 0) {
        <p class="empty">ç›®å‰æ²’æœ‰ä¸‹æ³¨è¨˜éŒ„</p>
      } @else {
        <div class="bet-table">
          @for (bet of allBets(); track bet.id) {
            <div class="bet-row" [class.paid]="bet.isPaid" [class.unpaid]="!bet.isPaid">
              <div class="bet-user">
                <strong>{{ bet.user?.name || 'æœªçŸ¥' }}</strong>
                <small>{{ bet.user?.email }}</small>
              </div>
              <div class="bet-gender">
                {{ bet.gender === 'BOY' ? 'ğŸ‘¦ ç”·ç”Ÿ' : 'ğŸ‘§ å¥³ç”Ÿ' }}
              </div>
              <div class="bet-amount">
                NT$ {{ bet.amount | number }}
              </div>
              <div class="bet-payment-method">
                @switch (bet.paymentMethod) {
                  @case ('bank_transfer') { ğŸ¦ éŠ€è¡Œè½‰å¸³ }
                  @case ('line_pay') { ğŸ’š LINE Pay }
                  @case ('cash') { ğŸ’µ ç¾é‡‘ }
                  @default { â“ æœªé¸æ“‡ }
                }
              </div>
              <div class="bet-date">
                {{ bet.createdAt | date:'MM/dd HH:mm' }}
              </div>
              <div class="bet-action">
                @if (bet.isPaid) {
                  <span class="status-badge paid">âœ“ å·²ä»˜æ¬¾</span>
                } @else {
                  <button
                    class="btn btn-confirm"
                    (click)="confirmPayment(bet)"
                    [disabled]="actionLoading()"
                  >
                    ç¢ºèªä»˜æ¬¾
                  </button>
                }
              </div>
            </div>
          }
        </div>
      }
    </section>

    <!-- Reveal & Draw Section -->
    <section class="reveal-section">
      <h2>ğŸ‰ æ­æ›‰ & æŠ½ç</h2>

      @if (revealConfig()?.isRevealed) {
        <!-- Already Revealed -->
        <div class="revealed-info">
          <p class="revealed-gender">
            å·²æ­æ›‰ï¼š{{ revealConfig()!.revealedGender === 'BOY' ? 'ğŸ‘¦ ç”·ç”Ÿ' : 'ğŸ‘§ å¥³ç”Ÿ' }}
          </p>

          @if (revealConfig()!.winnerId) {
            <div class="winner-info">
              <p>ğŸ† å¾—çè€…å·²æŠ½å‡º</p>
              @if (adminWinner()) {
                <div class="winner-detail">
                  <p class="winner-name">ğŸŠ {{ adminWinner()!.name }}</p>
                  @if (adminPrizeInfo()) {
                    <p>ç¸½çé‡‘æ± ï¼šNT$ {{ adminPrizeInfo()!.totalPool | number }}</p>
                    <p>æ‰‹çºŒè²» (10%)ï¼šNT$ {{ adminPrizeInfo()!.fee | number }}</p>
                    <p class="prize-amount">å¾—ä¸»çé‡‘ï¼šNT$ {{ adminPrizeInfo()!.winnerPrize | number }}</p>
                  }
                </div>
              }
            </div>
          } @else {
            <!-- Draw Winner -->
            <div class="draw-section">
              <p>çŒœå°äººæ•¸ï¼š{{ revealConfig()!.revealedGender === 'BOY' ? boyBets().length : girlBets().length }} äºº</p>
              <button
                class="btn btn-draw"
                (click)="drawWinner()"
                [disabled]="actionLoading()"
              >
                ğŸ² æŠ½å‡ºå¾—çè€…
              </button>
            </div>
          }
        </div>
      } @else {
        <!-- Not Yet Revealed -->
        <div class="reveal-actions">
          <p>é¸æ“‡å¯¶å¯¶çš„æ€§åˆ¥ä¾†æ­æ›‰ï¼š</p>
          <div class="reveal-buttons">
            <button
              class="btn btn-reveal boy"
              (click)="revealGender('BOY')"
              [disabled]="actionLoading()"
            >
              ğŸ‘¦ æ­æ›‰ç‚ºç”·ç”Ÿ
            </button>
            <button
              class="btn btn-reveal girl"
              (click)="revealGender('GIRL')"
              [disabled]="actionLoading()"
            >
              ğŸ‘§ æ­æ›‰ç‚ºå¥³ç”Ÿ
            </button>
          </div>
          <p class="warning">âš ï¸ æ­æ›‰å¾Œç„¡æ³•ä¿®æ”¹ï¼Œä¸‹æ³¨å°‡é—œé–‰</p>
        </div>
      }
    </section>

    <!-- Symptom Management -->
    <section class="symptom-section">
      <h2>ğŸ¤° å­•å¾µç®¡ç†</h2>
      <p class="section-desc">è¨­å®šå­•å¾µç·šç´¢ï¼Œå‹¾é¸åª½åª½çš„å¯¦éš›æƒ…æ³è®“å¤§å®¶åƒè€ƒ</p>

      @if (symptoms().length === 0) {
        <div class="empty-symptoms">
          <p>å°šæœªå»ºç«‹å­•å¾µè³‡æ–™</p>
          <button
            class="btn btn-init"
            (click)="initSymptoms()"
            [disabled]="actionLoading()"
          >
            ğŸ“‹ è¼‰å…¥é è¨­å­•å¾µ
          </button>
        </div>
      } @else {
        <div class="symptom-table">
          <div class="symptom-header">
            <span class="col-category">é …ç›®</span>
            <span class="col-boy">ğŸ‘¦ ç”·ç”Ÿç‰¹å¾µ</span>
            <span class="col-girl">ğŸ‘§ å¥³ç”Ÿç‰¹å¾µ</span>
            <span class="col-action"></span>
          </div>
          @for (symptom of symptoms(); track symptom.id) {
            <div class="symptom-row">
              <span class="col-category">{{ symptom.category }}</span>
              <button
                class="col-boy toggle-btn"
                [class.checked]="symptom.checkedGender === 'BOY'"
                (click)="toggleSymptom(symptom, 'BOY')"
              >
                @if (symptom.checkedGender === 'BOY') { âœ… }
                {{ symptom.boyDescription }}
              </button>
              <button
                class="col-girl toggle-btn"
                [class.checked]="symptom.checkedGender === 'GIRL'"
                (click)="toggleSymptom(symptom, 'GIRL')"
              >
                @if (symptom.checkedGender === 'GIRL') { âœ… }
                {{ symptom.girlDescription }}
              </button>
              <button class="col-action delete-symptom-btn" (click)="deleteSymptom(symptom)" title="åˆªé™¤">
                ğŸ—‘ï¸
              </button>
            </div>
          }
        </div>

        <!-- çˆ¸åª½é æ¸¬ -->
        <div class="predictions-section">
          <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ çˆ¸åª½é æ¸¬</h3>
          <div class="prediction-row">
            <label>çˆ¸çˆ¸é æ¸¬ï¼š</label>
            <div class="prediction-btns">
              <button
                class="pred-btn boy"
                [class.active]="dadPrediction() === 'BOY'"
                (click)="dadPrediction.set(dadPrediction() === 'BOY' ? null : 'BOY')"
              >ğŸ‘¦ ç”·</button>
              <button
                class="pred-btn girl"
                [class.active]="dadPrediction() === 'GIRL'"
                (click)="dadPrediction.set(dadPrediction() === 'GIRL' ? null : 'GIRL')"
              >ğŸ‘§ å¥³</button>
            </div>
          </div>
          <div class="prediction-row">
            <label>åª½åª½é æ¸¬ï¼š</label>
            <div class="prediction-btns">
              <button
                class="pred-btn boy"
                [class.active]="momPrediction() === 'BOY'"
                (click)="momPrediction.set(momPrediction() === 'BOY' ? null : 'BOY')"
              >ğŸ‘¦ ç”·</button>
              <button
                class="pred-btn girl"
                [class.active]="momPrediction() === 'GIRL'"
                (click)="momPrediction.set(momPrediction() === 'GIRL' ? null : 'GIRL')"
              >ğŸ‘§ å¥³</button>
            </div>
          </div>
          <button
            class="btn btn-save-pred"
            (click)="savePredictions()"
            [disabled]="actionLoading()"
          >
            ğŸ’¾ å„²å­˜é æ¸¬
          </button>
        </div>
      }

      <!-- Add Symptom -->
      <div class="add-symptom-area">
        <button class="btn btn-add-symptom" (click)="toggleAddSymptom()">
          {{ showAddSymptom() ? 'å–æ¶ˆ' : 'ï¼‹ æ–°å¢å­•å¾µ' }}
        </button>
        @if (showAddSymptom()) {
          <div class="add-symptom-form">
            <input
              type="text"
              placeholder="é …ç›®åç¨±ï¼ˆå¦‚ï¼šè‚šå‹ï¼‰"
              [ngModel]="newCategory()"
              (ngModelChange)="newCategory.set($event)"
            />
            <input
              type="text"
              placeholder="ç”·ç”Ÿç‰¹å¾µï¼ˆå¦‚ï¼šå°–å°–ï¼‰"
              [ngModel]="newBoyDesc()"
              (ngModelChange)="newBoyDesc.set($event)"
            />
            <input
              type="text"
              placeholder="å¥³ç”Ÿç‰¹å¾µï¼ˆå¦‚ï¼šåœ“åœ“ï¼‰"
              [ngModel]="newGirlDesc()"
              (ngModelChange)="newGirlDesc.set($event)"
            />
            <button
              class="btn btn-confirm"
              (click)="addSymptom()"
              [disabled]="!newCategory() || !newBoyDesc() || !newGirlDesc() || actionLoading()"
            >
              æ–°å¢
            </button>
          </div>
        }
      </div>
    </section>

    <!-- Dev Tools -->
    <section class="dev-section">
      <h2>ğŸ› ï¸ é–‹ç™¼å·¥å…·</h2>
      <p class="dev-warning">ä»¥ä¸‹æ“ä½œåƒ…ä¾›é–‹ç™¼æ¸¬è©¦ä½¿ç”¨</p>
      <button
        class="btn btn-danger"
        (click)="clearAllData()"
        [disabled]="actionLoading()"
      >
        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™
      </button>
    </section>
  }
</div>
